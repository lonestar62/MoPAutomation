{# METADATA:
id: secrets-management
name: Secrets Management
description: Update and rotate secrets and API keys
estimated_duration: 45
risk_level: high
approval_required: true
dependencies: []
#}

# Secrets Management - {{ region.upper() }}

## Overview

Secrets management procedure for **{{ azure_region }}** region.

### Secrets Context

- **Target Region**: {{ region.upper() }} ({{ azure_region }})
- **Key Vault**: {{ 'kv-' + region }}
- **Rotation Schedule**: {{ rotation_schedule | default('Quarterly') }}

## Secret Rotation

### Database Credentials
```bash
# Generate new database password
NEW_DB_PASSWORD=$(openssl rand -base64 32)

# Update password in Key Vault
az keyvault secret set \
  --vault-name {{ 'kv-' + region }} \
  --name db-password \
  --value "$NEW_DB_PASSWORD"

# Update application configuration
ansible {{ region }}_app -m replace -a "
  dest=/opt/app/config/database.conf
  regexp='password=.*'
  replace='password={{ '{{' }} vault_db_password {{ '}}' }}'
"
```

### API Keys
```bash
# Rotate API keys
NEW_API_KEY=$(uuidgen)
az keyvault secret set \
  --vault-name {{ 'kv-' + region }} \
  --name api-key \
  --value "$NEW_API_KEY"

# Update service configurations
ansible {{ region }}_web -m template -a "
  src=api-config.j2
  dest=/opt/web/config/api.conf
"
```

### SSL Certificates
```bash
# Update SSL certificate secrets
ansible {{ region }}_web -m copy -a "
  src={{ ssl_cert_path | default('/tmp/new-cert.pem') }}
  dest=/etc/ssl/certs/server.crt
  mode=0644
"

ansible {{ region }}_web -m copy -a "
  src={{ ssl_key_path | default('/tmp/new-key.pem') }}
  dest=/etc/ssl/private/server.key
  mode=0600
"
```

---

**Generated**: {{ generated_at }}  
**Template**: {{ template_source }}  
**Region**: {{ region.upper() }} ({{ azure_region }})