{# METADATA:
id: compliance-audit
name: Compliance Audit
description: Run compliance checks and generate audit reports
estimated_duration: 60
risk_level: low
approval_required: false
dependencies: []
#}

# Compliance Audit - {{ region.upper() }}

## Overview

Compliance audit procedure for **{{ azure_region }}** region.

### Audit Context

- **Target Region**: {{ region.upper() }} ({{ azure_region }})
- **Compliance Framework**: {{ compliance_framework | default('SOC2 + ISO27001') }}
- **Audit Date**: {{ audit_date | default(ansible_date_time.date) }}

## Security Compliance

### Access Control Audit
```bash
# Check user account compliance
ansible {{ region }}_all -m shell -a "
  awk -F: '(\$3 >= 1000) {print \$1}' /etc/passwd > /tmp/user_audit.txt
"

# Check sudo access
ansible {{ region }}_all -m shell -a "
  grep -r '^[^#]' /etc/sudoers.d/ > /tmp/sudo_audit.txt
"

# Check SSH key access
ansible {{ region }}_all -m find -a "
  paths=/home
  patterns=authorized_keys
  recurse=yes
" register: ssh_keys
```

### System Hardening Audit
```bash
# Check password policies
ansible {{ region }}_all -m shell -a "
  grep -E '^(PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE)' /etc/login.defs
"

# Check firewall status
ansible {{ region }}_all -m shell -a "
  iptables -L -n | head -20
"

# Check service exposure
ansible {{ region }}_all -m shell -a "
  netstat -tlnp | grep -E ':(22|80|443|3306|5432)'
"
```

## Data Protection Audit

### Encryption Status
```bash
# Check disk encryption
ansible {{ region }}_all -m shell -a "
  lsblk -f | grep crypto
"

# Check SSL/TLS configuration
ansible {{ region }}_web -m shell -a "
  openssl s_client -connect localhost:443 -brief
"
```

### Backup Verification
```bash
# Check backup schedules
ansible {{ region }}_all -m shell -a "
  crontab -l | grep backup
"

# Verify backup integrity
ansible {{ region }}_all -m shell -a "
  find /backup -name '*.gz' -mtime -1 | wc -l
"
```

## Audit Report Generation

### Compliance Report
```bash
# Generate compliance report
ansible {{ region }}_all -m template -a "
  src=compliance-report.j2
  dest=/tmp/compliance-report-{{ region }}-{{ ansible_date_time.date }}.html
"
```

---

**Generated**: {{ generated_at }}  
**Template**: {{ template_source }}  
**Region**: {{ region.upper() }} ({{ azure_region }})